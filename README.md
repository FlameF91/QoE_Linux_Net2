# TC 网络条件切换工具

QoE 实验用 Linux TC（Traffic Control）网络条件模拟脚本。

---

## 文件说明

| 文件 | 说明 |
|------|------|
| `tc_switch.sh` | 主脚本，执行网络条件切换 |
| `Network Condition Profiles.txt` | 网络条件配置文件（14 个条件） |
| `tc_experiment.log` | 实验日志（运行后自动生成） |

---

## 环境要求

- Linux 系统（需要 `tc` / `iproute2`）
- Bash 4.0+（需要关联数组支持）
- root 权限

---

## 快速开始

### 1. 上传文件到 Linux 服务器

将以下两个文件放在**同一目录**下：

```
/home/user/experiment/
├── tc_switch.sh
└── Network Condition Profiles.txt
```

### 2. 赋予执行权限

```bash
chmod +x tc_switch.sh
```

### 3. 运行脚本

```bash
sudo bash tc_switch.sh
```

---

## 使用流程

### 第一步：选择网络接口

脚本启动后会列出所有可用的网络接口，输入要控制的接口名称：

```
可用的网络接口:
  lo                   UNKNOWN
  eth0                 UP
  
请输入要使用的网络接口名称: eth0
```

### 第二步：逐个进行实验

脚本会以**随机顺序**应用 14 个网络条件，每次需手动按回车确认：

```
════════════════════════════════════════════════════════════

  ▶ 即将进行第 1/14 个实验 （第 1 组）
════════════════════════════════════════════════════════════

  按回车键应用第 1 个实验的网络条件...

  [TC] 命令执行成功

  ✔ 第 1/14 个实验条件已应用, 请开始测试。
```

从第 2 个实验开始，每次会**揭示上一个实验的网络条件**：

```
  ╔══════════════════════════════════════════════════════╗
  ║  [揭示] 第 1/14 个实验的网络条件:
  ║  C07 (RTT: 100ms, Jitter: 40ms, 丢包率: 0%)
  ╚══════════════════════════════════════════════════════╝

  ▶ 即将进行第 2/14 个实验 （第 1 组）
```

> **注意：** 当前实验的网络条件不会立即显示，而是在下一个实验开始前揭示，适用于盲测场景。

### 第三步：实验结束

14 个条件全部执行完后：

1. 揭示最后一个实验的网络条件
2. **自动清除 TC 规则**，恢复正常网络
3. 显示本组实验汇总表

```
        第 1 组实验汇总
════════════════════════════════════════════════════════════

  实验序号   条件ID   RTT(往返)    Jitter(抖动)   丢包率
  ──────── ────── ────────── ──────────── ────────
  1/14       C07      100ms        40ms           0%
  2/14       C03      25ms         40ms           0%
  ...
  14/14      C01      0ms          0ms            0%

  ✔ 第 1 组实验已全部完成！
```

---

## 日志说明

所有操作记录追加写入 `tc_experiment.log`，不会覆盖历史数据。

日志内容包括：

- 实验日期和时间
- 组号（自动从历史日志中推算）
- 每次实验的条件 ID、RTT、Jitter、丢包率
- 实际执行的 `tc` 命令
- 执行结果（成功/失败）
- 实验汇总

日志示例：

```
[2026-02-09 14:30:00] ========================================================
[2026-02-09 14:30:00] 第 1 组实验开始
[2026-02-09 14:30:00] 日期时间: 2026-02-09 14:30:00
[2026-02-09 14:30:00] 网络接口: eth0
[2026-02-09 14:30:05] --- 第 1/14 个实验 ---
[2026-02-09 14:30:05]   应用条件 ID: C07
[2026-02-09 14:30:05]   RTT: 100ms (单向延迟: 50.0ms)
[2026-02-09 14:30:05]   Jitter: 40ms
[2026-02-09 14:30:05]   丢包率: 0%
[2026-02-09 14:30:05]   执行: tc qdisc add dev eth0 root netem delay 50.0ms 40ms distribution normal
[2026-02-09 14:30:05]   结果: 成功
```

---

## 网络条件配置

共 14 个条件（`Network Condition Profiles.txt`）：

| ID | RTT (往返) | Jitter (抖动) | 丢包率 |
|----|-----------|--------------|--------|
| C01 | 0ms | 0ms | 0% |
| C02 | 25ms | 10ms | 0% |
| C03 | 25ms | 40ms | 0% |
| C04 | 50ms | 10ms | 0% |
| C05 | 50ms | 40ms | 0% |
| C06 | 100ms | 10ms | 0% |
| C07 | 100ms | 40ms | 0% |
| C08 | 25ms | 0ms | 1% |
| C09 | 25ms | 0ms | 4% |
| C10 | 50ms | 0ms | 1% |
| C11 | 50ms | 0ms | 4% |
| C12 | 100ms | 0ms | 1% |
| C13 | 100ms | 0ms | 4% |
| C14 | 100ms | 40ms | 4% |

> RTT 会自动除以 2 作为 `tc netem delay` 的单向延迟值。

---

## 中断处理

实验过程中按 `Ctrl+C` 会：

1. 自动清除 TC 规则，恢复正常网络
2. 在日志中记录中断事件

---

## 常见问题

**Q: 如何查看当前 TC 规则？**

```bash
tc qdisc show dev eth0
```

**Q: 如何手动清除 TC 规则？**

```bash
sudo tc qdisc del dev eth0 root
```

**Q: 脚本提示 "需要 root 权限"？**

```bash
sudo bash tc_switch.sh
```

**Q: 如何查看已进行了几组实验？**

```bash
grep '实验组完成' tc_experiment.log
```
